<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í•˜ì´ë¸Œë¦¬ë“œ ì±—ë´‡ í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 p-4">
    <div class="max-w-2xl mx-auto">
      <h1 class="text-2xl font-bold mb-4">í•˜ì´ë¸Œë¦¬ë“œ ì±—ë´‡ í…ŒìŠ¤íŠ¸</h1>

      <div class="bg-white p-4 rounded-lg shadow mb-4">
        <h2 class="font-bold mb-2">ì±—ë´‡ ìƒíƒœ</h2>
        <div id="status" class="text-gray-600">í™•ì¸ ì¤‘...</div>
        <button
          id="init-btn"
          class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
        >
          ì±—ë´‡ ì´ˆê¸°í™”
        </button>
      </div>

      <div class="bg-white p-4 rounded-lg shadow mb-4">
        <h2 class="font-bold mb-2">í…ŒìŠ¤íŠ¸ ì§ˆë¬¸</h2>
        <input
          id="query"
          type="text"
          placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”"
          class="w-full p-2 border rounded mb-2"
        />
        <button
          id="send-btn"
          class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
        >
          ì§ˆë¬¸í•˜ê¸°
        </button>
      </div>

      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="font-bold mb-2">ì‘ë‹µ</h2>
        <div id="response" class="whitespace-pre-wrap">
          ì—¬ê¸°ì— ì‘ë‹µì´ í‘œì‹œë©ë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <script>
      // ìƒíƒœ í™•ì¸
      async function checkStatus() {
        try {
          const response = await fetch("/api/chatbot/status");
          const data = await response.json();
          const statusEl = document.getElementById("status");

          if (data.ready) {
            statusEl.textContent = "âœ… ì±—ë´‡ ì¤€ë¹„ë¨";
            statusEl.className = "text-green-500";
          } else if (data.initializing) {
            statusEl.textContent = "ğŸ”„ ì´ˆê¸°í™” ì¤‘...";
            statusEl.className = "text-yellow-500";
          } else {
            statusEl.textContent = "âŒ ì´ˆê¸°í™” í•„ìš”";
            statusEl.className = "text-red-500";
          }
        } catch (error) {
          console.error("ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:", error);
        }
      }

      // ì´ˆê¸°í™”
      document
        .getElementById("init-btn")
        .addEventListener("click", async () => {
          try {
            const response = await fetch("/api/chatbot/initialize", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });
            const data = await response.json();
            alert(data.message);

            // ìƒíƒœ í™•ì¸ ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰
            const interval = setInterval(async () => {
              await checkStatus();
              if ((await fetch("/api/chatbot/status")).json().ready) {
                clearInterval(interval);
              }
            }, 5000);
          } catch (error) {
            console.error("ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
          }
        });

      // ì§ˆë¬¸í•˜ê¸°
      document
        .getElementById("send-btn")
        .addEventListener("click", async () => {
          const query = document.getElementById("query").value;
          if (!query) return;

          try {
            const response = await fetch("/api/chatbot/query", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ query }),
            });

            const data = await response.json();
            const responseEl = document.getElementById("response");

            if (data.status === "success") {
              let responseHtml = `<div class="font-bold mb-2">ë‹µë³€:</div>`;
              responseHtml += `<div class="mb-4">${data.answer}</div>`;

              if (data.sources) {
                responseHtml += `<div class="font-bold mb-2">ì¶œì²˜:</div>`;
                responseHtml += `<div class="text-sm">`;

                if (data.sources.type === "hybrid") {
                  responseHtml += `<div class="text-green-600">ğŸŒ ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ + ë‚´ë¶€ ë¬¸ì„œ ê²°í•©</div>`;
                } else if (data.sources.type === "rag_only") {
                  responseHtml += `<div class="text-blue-600">ğŸ“– ë‚´ë¶€ ë¬¸ì„œ ê¸°ë°˜ ë‹µë³€</div>`;
                }

                if (data.sources.internal_docs) {
                  responseHtml += `<div class="mt-2">ë‚´ë¶€ ë¬¸ì„œ:</div>`;
                  data.sources.internal_docs.forEach((doc) => {
                    responseHtml += `<div>- ${doc.title} (${doc.source_type})</div>`;
                  });
                }

                if (data.sources.web_search) {
                  responseHtml += `<div class="mt-2 text-green-600">${data.sources.web_search}</div>`;
                }

                responseHtml += `</div>`;
              }

              responseEl.innerHTML = responseHtml;
            } else {
              responseEl.innerHTML = `<div class="text-red-500">ì˜¤ë¥˜: ${data.message}</div>`;
            }
          } catch (error) {
            console.error("ì§ˆë¬¸ ì˜¤ë¥˜:", error);
            document.getElementById(
              "response"
            ).innerHTML = `<div class="text-red-500">ì˜¤ë¥˜: ${error.message}</div>`;
          }
        });

      // ì´ˆê¸° ìƒíƒœ í™•ì¸
      checkStatus();
      setInterval(checkStatus, 10000); // 10ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
    </script>
  </body>
</html>
