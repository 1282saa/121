<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>경제용 AI 검색</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
      }
      .citation-link {
        color: #3b82f6;
        text-decoration: none;
        font-size: 0.75rem;
        vertical-align: super;
        margin: 0 2px;
        cursor: pointer;
      }
      .citation-link:hover {
        text-decoration: underline;
      }
      .search-suggestion {
        transition: all 0.2s;
      }
      .search-suggestion:hover {
        background-color: #f3f4f6;
        transform: translateX(4px);
      }
      .answer-container {
        line-height: 1.8;
      }
      .answer-container h2,
      .answer-container h3 {
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        font-weight: bold;
      }
      .answer-container p {
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body
    class="flex flex-col min-h-screen items-center p-4 selection:bg-orange-200 selection:text-orange-800"
  >
    <header class="w-full max-w-5xl text-center py-8">
      <div class="flex justify-center items-center space-x-4">
        <h1 class="text-4xl font-bold text-orange-500">경제용</h1>
        <a
          href="https://www.instagram.com/economy_dragon_/"
          target="_blank"
          class="text-orange-500 hover:text-orange-600 transition-colors"
        >
          <i class="fab fa-instagram text-3xl"></i>
        </a>
      </div>
      <p class="mt-2 text-gray-600">
        경제 용어와 최신 경제 콘텐츠를 쉽게 알아보세요! 🐲
      </p>
    </header>

    <div class="w-full max-w-5xl mb-6 px-4 sm:px-0">
      <div class="relative">
        <input
          type="text"
          id="global-search"
          placeholder="경제 용어 또는 콘텐츠 검색..."
          class="w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none"
        />
        <svg
          class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
      </div>
    </div>

    <div class="w-full max-w-5xl mb-6">
      <div
        class="flex justify-center space-x-4 sm:space-x-8 border-b border-gray-200 pb-2"
      >
        <button
          id="tab-chatbot"
          class="tab-button text-md sm:text-lg py-2 px-3 sm:px-4 active"
        >
          AI 검색
        </button>
        <button
          id="tab-terms"
          class="tab-button text-md sm:text-lg py-2 px-3 sm:px-4"
        >
          경제 용어
        </button>
        <button
          id="tab-contents"
          class="tab-button text-md sm:text-lg py-2 px-3 sm:px-4"
        >
          최신 콘텐츠
        </button>
      </div>
    </div>

    <main
      id="chatbot-section"
      class="w-full max-w-3xl flex-grow flex flex-col bg-white shadow-2xl rounded-xl p-6 space-y-6 border border-gray-200"
    >
      <div
        class="flex items-center justify-center space-x-4 p-4 bg-orange-50 rounded-lg"
      >
        <img
          src="https://img2.stibee.com/d2fad6b1-3012-4b5c-943a-3ca4c6a1b546.png"
          alt="[귀여운 경제용 캐릭터]"
          class="dragon-character-image"
        />
        <div>
          <p class="text-xl font-semibold text-orange-700">
            안녕! 나는 경제용이야.
          </p>
          <p class="text-md text-orange-600">
            어려운 경제, 내가 쉽고 재미있게 알려줄게! 뭐든지 물어봐용~
          </p>
        </div>
      </div>

      <!-- 추천 검색어 -->
      <div id="suggested-searches" class="mb-4">
        <h3 class="text-lg font-medium mb-4">추천 AI 검색어</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div
            class="search-suggestion bg-white p-4 rounded-lg cursor-pointer border hover:border-orange-200"
          >
            <p class="text-gray-800">ETF란 무엇인가요?</p>
          </div>
          <div
            class="search-suggestion bg-white p-4 rounded-lg cursor-pointer border hover:border-orange-200"
          >
            <p class="text-gray-800">금리인상이 주식시장에 미치는 영향은?</p>
          </div>
          <div
            class="search-suggestion bg-white p-4 rounded-lg cursor-pointer border hover:border-orange-200"
          >
            <p class="text-gray-800">인플레이션 헤지 방법은 무엇인가요?</p>
          </div>
          <div
            class="search-suggestion bg-white p-4 rounded-lg cursor-pointer border hover:border-orange-200"
          >
            <p class="text-gray-800">요즘 주목받는 경제 이슈는 무엇인가요?</p>
          </div>
        </div>
      </div>

      <!-- 대화 출력 영역 -->
      <div
        id="chat-output"
        class="flex-grow h-96 overflow-y-auto p-4 space-y-2 border border-gray-200 rounded-lg bg-gray-50"
      >
        <div class="chat-bubble bot-bubble">
          <span class="font-semibold">경제용:</span> 무엇이 궁금한가용? 경제
          관련 질문을 해보세용!
        </div>
      </div>

      <!-- 검색 결과 영역 -->
      <div id="search-results" class="hidden">
        <!-- 로딩 상태 -->
        <div id="loading-state" class="hidden">
          <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center gap-3">
              <div
                class="animate-spin rounded-full h-8 w-8 border-4 border-orange-500 border-t-transparent"
              ></div>
              <p class="text-gray-600">답변을 생성하고 있습니다...</p>
            </div>
          </div>
        </div>

        <!-- 답변 영역 -->
        <div id="answer-area" class="hidden">
          <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-start gap-3 mb-4">
              <div class="p-2 bg-orange-100 rounded-lg">
                <i class="fas fa-sparkles text-orange-600"></i>
              </div>
              <h3 class="text-lg font-medium">AI 요약</h3>
            </div>
            <div
              id="answer-content"
              class="answer-container text-gray-800"
            ></div>
          </div>

          <!-- 출처 섹션 -->
          <div id="sources-area" class="bg-white rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-medium mb-4">출처</h3>
            <div id="sources-list" class="space-y-3"></div>
          </div>
        </div>
      </div>

      <div class="flex items-center space-x-3 pt-4 border-t border-gray-200">
        <input
          type="text"
          id="chat-input"
          placeholder="여기에 질문을 입력하세요..."
          class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none transition-all duration-150 ease-in-out"
        />
        <button
          id="send-button"
          class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out transform hover:scale-105 active:bg-orange-700"
        >
          검색
        </button>
      </div>
    </main>

    <main
      id="terms-section"
      class="w-full max-w-5xl flex-grow flex-col bg-white shadow-2xl rounded-xl p-6 space-y-6 border border-gray-200 hidden"
    >
      <h2
        class="text-2xl font-bold text-orange-500 mb-6 text-center sm:text-left"
      >
        경제 용어 모음
        <span id="terms-count" class="text-sm font-normal text-gray-500"
          >(0)</span
        >
      </h2>
      <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
        <div class="relative flex-grow md:max-w-md">
          <input
            type="text"
            id="terms-search"
            placeholder="경제 용어 검색..."
            class="w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none"
          />
          <svg
            class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            />
          </svg>
        </div>
        <div class="flex items-center">
          <span class="text-sm text-gray-600 mr-2">정렬:</span>
          <select
            id="terms-sort"
            class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none"
          >
            <option value="number-asc">번호 오름차순</option>
            <option value="number-desc">번호 내림차순</option>
            <option value="title-asc">제목 오름차순</option>
            <option value="title-desc">제목 내림차순</option>
          </select>
        </div>
      </div>
      <div
        id="terms-grid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      ></div>
      <div id="terms-no-results" class="text-center py-10 hidden">
        <p class="text-gray-500">검색 결과가 없습니다.</p>
        <button
          id="terms-reset-search"
          class="mt-2 text-orange-500 hover:text-orange-600"
        >
          검색 초기화
        </button>
      </div>
    </main>

    <main
      id="contents-section"
      class="w-full max-w-5xl flex-grow flex-col bg-white shadow-2xl rounded-xl p-6 space-y-6 border border-gray-200 hidden"
    >
      <h2
        class="text-2xl font-bold text-orange-500 mb-6 text-center sm:text-left"
      >
        최신 경제 콘텐츠
        <span id="contents-count" class="text-sm font-normal text-gray-500"
          >(0)</span
        >
      </h2>
      <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
        <div class="relative flex-grow md:max-w-md">
          <input
            type="text"
            id="contents-search"
            placeholder="콘텐츠 검색..."
            class="w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none"
          />
          <svg
            class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            />
          </svg>
        </div>
        <div class="flex items-center">
          <span class="text-sm text-gray-600 mr-2">정렬:</span>
          <select
            id="contents-sort"
            class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent outline-none"
          >
            <option value="number-desc">번호 내림차순</option>
            <option value="number-asc">번호 오름차순</option>
            <option value="title-asc">제목 오름차순</option>
            <option value="title-desc">제목 내림차순</option>
          </select>
        </div>
      </div>
      <div
        id="contents-grid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      ></div>
      <div id="contents-no-results" class="text-center py-10 hidden">
        <p class="text-gray-500">검색 결과가 없습니다.</p>
        <button
          id="contents-reset-search"
          class="mt-2 text-orange-500 hover:text-orange-600"
        >
          검색 초기화
        </button>
      </div>
    </main>

    <div id="content-modal" class="modal">
      <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
          <h2 id="modal-title" class="text-2xl font-bold text-orange-500"></h2>
          <button
            id="modal-close"
            class="text-gray-500 hover:text-gray-700 p-2 transition-colors duration-200 rounded-full hover:bg-gray-100"
          >
            <svg
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>
        <div id="modal-date" class="text-sm text-gray-500 mb-4"></div>
        <div id="modal-content-body" class="markdown-content"></div>
        <div class="mt-6 text-center">
          <button
            id="modal-close-bottom"
            class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors duration-200"
          >
            닫기
          </button>
        </div>
      </div>
    </div>

    <footer class="w-full max-w-5xl text-center py-8 mt-12">
      <h2 class="text-2xl font-semibold text-gray-700 mb-6">
        놓치면 아쉬운 경제용 이야기 🐲
      </h2>
      <div class="space-y-3">
        <div
          class="footer-list-item p-4 bg-white border border-gray-200 hover:border-orange-200 rounded-lg shadow-sm cursor-pointer text-left"
        >
          <h3 class="font-bold text-orange-600 text-lg">
            📈 ETF, 제대로 알고 투자하기
          </h3>
          <p class="text-sm text-gray-600 mt-1">
            분산투자의 마법사 ETF! 개념부터 활용 전략까지 경제용이 콕콕
            알려줄게용.
          </p>
        </div>
        <div
          class="footer-list-item p-4 bg-white border border-gray-200 hover:border-orange-200 rounded-lg shadow-sm cursor-pointer text-left"
        >
          <h3 class="font-bold text-orange-600 text-lg">
            🏦 금리 변동, 내 지갑에 미치는 영향은?
          </h3>
          <p class="text-sm text-gray-600 mt-1">
            금리가 오르락내리락~ 내 자산 관리는 어떻게 해야 할까용? 경제용과
            함께 알아봐용!
          </p>
        </div>
        <div
          class="footer-list-item p-4 bg-white border border-gray-200 hover:border-orange-200 rounded-lg shadow-sm cursor-pointer text-left"
        >
          <h3 class="font-bold text-orange-600 text-lg">
            📊 주린이를 위한 첫걸음, 주식 투자 가이드
          </h3>
          <p class="text-sm text-gray-600 mt-1">
            주식 투자가 처음이라면? 경제용이 알려주는 필수 용어와 투자 원칙!
            겁먹지 말고 시작해용!
          </p>
        </div>
      </div>
      <div class="mt-6 flex justify-center items-center">
        <a
          href="https://www.instagram.com/economy_dragon_/"
          target="_blank"
          class="flex items-center text-orange-500 hover:text-orange-600 transition-colors"
        >
          <i class="fab fa-instagram text-xl mr-2"></i>
          <span>@economy_dragon_</span>
        </a>
      </div>
    </footer>

    <!-- JavaScript 파일 로드 -->
    <script src="static/js/content-data.js"></script>
    <script src="static/js/chatbot.js"></script>
    <script src="static/js/content-manager.js"></script>
    <script src="static/js/app.js"></script>

    <!-- 챗봇 섹션 업데이트 -->
    <div id="chatbot-section" class="tab-content hidden">
      <div class="p-4">
        <h2 class="text-2xl font-bold mb-4">경제용 AI 검색</h2>

        <!-- RAG 상태 및 초기화 버튼 -->
        <div class="rag-status-container">
          <div id="rag-status" class="text-gray-500">
            AI 고급 기능: 비활성화
          </div>
          <button
            id="init-rag-button"
            class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-opacity-50"
          >
            AI 고급 기능 활성화
          </button>
        </div>

        <!-- 추천 검색어 영역 -->
        <div id="ai-suggested-searches" class="mt-4 mb-6">
          <h3 class="text-lg font-medium mb-3">추천 검색어</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div
              class="search-suggestion bg-white p-3 rounded-lg cursor-pointer border hover:border-orange-200 shadow-sm"
            >
              <p class="text-gray-800">ETF란 무엇인가요?</p>
            </div>
            <div
              class="search-suggestion bg-white p-3 rounded-lg cursor-pointer border hover:border-orange-200 shadow-sm"
            >
              <p class="text-gray-800">금리인상이 주식시장에 미치는 영향은?</p>
            </div>
            <div
              class="search-suggestion bg-white p-3 rounded-lg cursor-pointer border hover:border-orange-200 shadow-sm"
            >
              <p class="text-gray-800">인플레이션 헤지 방법은 무엇인가요?</p>
            </div>
            <div
              class="search-suggestion bg-white p-3 rounded-lg cursor-pointer border hover:border-orange-200 shadow-sm"
            >
              <p class="text-gray-800">요즘 주목받는 경제 이슈는 무엇인가요?</p>
            </div>
          </div>
        </div>

        <div class="chat-container">
          <div id="ai-chat-output" class="chat-output"></div>

          <!-- 검색 결과 영역 -->
          <div id="ai-search-results" class="hidden">
            <!-- 로딩 상태 -->
            <div
              id="ai-loading-state"
              class="bg-white rounded-lg shadow-sm p-4 mb-4 hidden"
            >
              <div class="flex items-center gap-3">
                <div
                  class="animate-spin rounded-full h-6 w-6 border-4 border-orange-500 border-t-transparent"
                ></div>
                <p class="text-gray-600">답변을 생성하고 있습니다...</p>
              </div>
            </div>

            <!-- 답변 영역 -->
            <div id="ai-answer-area" class="hidden">
              <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                <div class="flex items-start gap-3 mb-3">
                  <div class="p-2 bg-orange-100 rounded-lg">
                    <i class="fas fa-lightbulb text-orange-600"></i>
                  </div>
                  <h3 class="text-lg font-medium">AI 요약</h3>
                </div>
                <div
                  id="ai-answer-content"
                  class="answer-container text-gray-800"
                ></div>
              </div>

              <!-- 출처 섹션 -->
              <div
                id="ai-sources-area"
                class="bg-white rounded-lg shadow-sm p-4 mb-4"
              >
                <h3 class="text-lg font-medium mb-3">출처</h3>
                <div id="ai-sources-list" class="space-y-3"></div>
              </div>
            </div>
          </div>

          <div class="chat-input-container mt-4">
            <input
              id="ai-chat-input"
              type="text"
              placeholder="경제 관련 질문을 입력하세요..."
              class="flex-grow px-4 py-2 border rounded-l-md focus:outline-none w-full"
            />
            <button
              id="ai-send-button"
              class="px-4 py-2 bg-orange-500 text-white rounded-r-md hover:bg-orange-600 focus:outline-none"
            >
              검색
            </button>
          </div>
        </div>

        <div class="mt-4 text-sm text-gray-500">
          <p>
            💡 <strong>사용 팁:</strong> 경제 용어나 투자 방법에 대해
            검색해보세요. AI 고급 기능을 활성화하면 더 정확한 답변을 받을 수
            있습니다.
          </p>
          <p class="mt-2">
            📚 <strong>예시 질문:</strong> "ETF가 무엇인가요?", "주식과 채권의
            차이는?", "요즘 비트코인 상승 이유는?"
          </p>
        </div>
      </div>
    </div>

    <!-- .env 파일 생성 안내 모달 -->
    <div id="env-modal" class="modal hidden">
      <div class="modal-content max-w-md">
        <span class="close">&times;</span>
        <h2 class="text-xl font-bold mb-4">API 키 설정 필요</h2>
        <p class="mb-4">
          RAG 챗봇을 사용하기 위해 OpenAI API 키가 필요합니다. 프로젝트 루트
          디렉토리에 <code>.env</code> 파일을 생성하고 다음 내용을 추가해주세요:
        </p>
        <div class="bg-gray-100 p-3 rounded mb-4 font-mono">
          OPENAI_API_KEY=your_api_key_here
        </div>
        <p class="text-sm text-gray-500">
          API 키는
          <a
            href="https://platform.openai.com/account/api-keys"
            target="_blank"
            class="text-orange-500 hover:underline"
            >OpenAI 웹사이트</a
          >에서 발급받을 수 있습니다.
        </p>
        <button
          id="close-env-modal"
          class="mt-4 px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600 focus:outline-none"
        >
          확인
        </button>
      </div>
    </div>

    <script>
      // 전역 변수
      let currentCitations = [];

      // 탭 전환
      document.querySelectorAll(".tab-button").forEach((button) => {
        button.addEventListener("click", () => {
          const targetTab = button.dataset.tab;

          // 탭 버튼 스타일 업데이트
          document.querySelectorAll(".tab-button").forEach((btn) => {
            btn.classList.remove("text-blue-600", "font-medium");
            btn.classList.add("text-gray-600");
          });
          button.classList.remove("text-gray-600");
          button.classList.add("text-blue-600", "font-medium");

          // 콘텐츠 전환
          document.querySelectorAll(".tab-content").forEach((content) => {
            content.classList.add("hidden");
          });
          document
            .getElementById(`${targetTab}-section`)
            .classList.remove("hidden");
        });
      });

      // 검색 기능
      async function performSearch(query) {
        if (!query.trim()) return;

        // UI 상태 변경
        document.getElementById("suggested-searches").classList.add("hidden");
        document.getElementById("search-results").classList.remove("hidden");
        document.getElementById("loading-state").classList.remove("hidden");
        document.getElementById("answer-area").classList.add("hidden");

        try {
          const response = await fetch("/api/ai-search", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ query }),
          });

          const result = await response.json();

          if (result.status === "success") {
            displayResults(result);
          } else {
            displayError(result.message);
          }
        } catch (error) {
          displayError("검색 중 오류가 발생했습니다.");
        }
      }

      // 결과 표시
      function displayResults(result) {
        document.getElementById("loading-state").classList.add("hidden");
        document.getElementById("answer-area").classList.remove("hidden");

        // 답변 표시 (각주 번호 포함)
        const answerWithCitations = addCitationLinks(result.answer);
        document.getElementById("answer-content").innerHTML =
          marked.parse(answerWithCitations);

        // 출처 표시
        currentCitations = result.citations;
        displaySources(result.citations);
      }

      // 각주 링크 추가
      function addCitationLinks(text) {
        // [1], [2] 형식의 각주를 클릭 가능한 링크로 변환
        return text.replace(/\[(\d+)\]/g, (match, num) => {
          return `<a href="#citation-${num}" class="citation-link" onclick="scrollToCitation(${num}); return false;">[${num}]</a>`;
        });
      }

      // 출처 표시
      function displaySources(citations) {
        const sourcesContainer = document.getElementById("sources-list");
        sourcesContainer.innerHTML = "";

        citations.forEach((citation) => {
          const sourceDiv = document.createElement("div");
          sourceDiv.className =
            "p-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors";
          sourceDiv.id = `citation-${citation.number}`;

          if (citation.type === "internal") {
            // 내부 문서 출처
            sourceDiv.innerHTML = `
              <div class="flex items-start gap-3">
                <div class="text-gray-400">${citation.number}</div>
                <div class="flex-1">
                  <h4 class="font-medium text-gray-800">${citation.title}</h4>
                  <p class="text-sm text-gray-600 mt-1">${citation.content}</p>
                  <p class="text-xs text-blue-600 mt-2">
                    경제용 ${
                      citation.source_type === "economy_terms"
                        ? "경제 용어"
                        : "최신 콘텐츠"
                    }
                  </p>
                </div>
              </div>
            `;

            // 클릭 시 내부 문서로 이동
            sourceDiv.addEventListener("click", () => {
              openInternalDocument(citation.file_name, citation.source_type);
            });
          } else {
            // 웹 검색 출처
            sourceDiv.innerHTML = `
              <div class="flex items-start gap-3">
                <div class="text-gray-400">${citation.number}</div>
                <div class="flex-1">
                  <h4 class="font-medium text-gray-800">${citation.title}</h4>
                  <p class="text-sm text-gray-600 mt-1">${citation.content}</p>
                  <p class="text-xs text-green-600 mt-2">웹 검색 결과</p>
                </div>
              </div>
            `;
          }

          sourcesContainer.appendChild(sourceDiv);
        });
      }

      // 내부 문서 열기
      function openInternalDocument(fileName, sourceType) {
        // 경제용 탭 전환 및 모달 열기
        if (window.parent && window.parent.ContentManager) {
          // 해당 탭으로 전환
          const tabId =
            sourceType === "economy_terms" ? "tab-terms" : "tab-contents";
          window.parent.document.getElementById(tabId).click();

          // 모달 열기
          window.parent.ContentManager.openContentModal(fileName, sourceType);
        } else {
          // 새 창에서 열기
          window.open(`/view/${sourceType}/${fileName}`, "_blank");
        }
      }

      // 각주로 스크롤
      function scrollToCitation(num) {
        const element = document.getElementById(`citation-${num}`);
        if (element) {
          element.scrollIntoView({ behavior: "smooth", block: "center" });
          element.classList.add("bg-blue-50");
          setTimeout(() => {
            element.classList.remove("bg-blue-50");
          }, 2000);
        }
      }

      // 오류 표시
      function displayError(message) {
        document.getElementById("loading-state").classList.add("hidden");
        document.getElementById("answer-area").classList.remove("hidden");
        document.getElementById("answer-content").innerHTML = `
          <div class="text-red-600">
            <i class="fas fa-exclamation-circle"></i> ${message}
          </div>
        `;
        document.getElementById("sources-area").classList.add("hidden");
      }

      // 이벤트 리스너 설정
      document.getElementById("send-button").addEventListener("click", () => {
        const query = document.getElementById("chat-input").value;
        performSearch(query);
      });

      document.getElementById("chat-input").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const query = e.target.value;
          performSearch(query);
        }
      });

      // AI 검색 탭의 이벤트 리스너
      document
        .getElementById("ai-send-button")
        .addEventListener("click", () => {
          const query = document.getElementById("ai-chat-input").value;
          performAISearch(query);
        });

      document
        .getElementById("ai-chat-input")
        .addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            const query = e.target.value;
            performAISearch(query);
          }
        });

      // AI 검색 기능
      async function performAISearch(query) {
        if (!query.trim()) return;

        // UI 상태 변경
        document
          .getElementById("ai-suggested-searches")
          .classList.add("hidden");
        document.getElementById("ai-search-results").classList.remove("hidden");
        document.getElementById("ai-loading-state").classList.remove("hidden");
        document.getElementById("ai-answer-area").classList.add("hidden");

        try {
          const response = await fetch("/api/ai-search", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ query }),
          });

          const result = await response.json();

          if (result.status === "success") {
            displayAIResults(result);
          } else {
            displayAIError(result.message);
          }
        } catch (error) {
          displayAIError("검색 중 오류가 발생했습니다.");
        }
      }

      // AI 검색 결과 표시
      function displayAIResults(result) {
        document.getElementById("ai-loading-state").classList.add("hidden");
        document.getElementById("ai-answer-area").classList.remove("hidden");

        // 답변 표시 (각주 번호 포함)
        const answerWithCitations = addCitationLinks(result.answer);
        document.getElementById("ai-answer-content").innerHTML =
          marked.parse(answerWithCitations);

        // 출처 표시
        displayAISources(result.citations);
      }

      // AI 검색 오류 표시
      function displayAIError(message) {
        document.getElementById("ai-loading-state").classList.add("hidden");
        document.getElementById("ai-answer-area").classList.remove("hidden");
        document.getElementById("ai-answer-content").innerHTML = `
          <div class="text-red-600">
            <i class="fas fa-exclamation-circle"></i> ${message}
          </div>
        `;
        document.getElementById("ai-sources-area").classList.add("hidden");
      }

      // AI 검색 출처 표시
      function displayAISources(citations) {
        const sourcesContainer = document.getElementById("ai-sources-list");
        sourcesContainer.innerHTML = "";

        citations.forEach((citation) => {
          const sourceDiv = document.createElement("div");
          sourceDiv.className =
            "p-3 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors";
          sourceDiv.id = `ai-citation-${citation.number}`;

          if (citation.type === "internal") {
            // 내부 문서 출처
            sourceDiv.innerHTML = `
              <div class="flex items-start gap-3">
                <div class="text-gray-400">${citation.number}</div>
                <div class="flex-1">
                  <h4 class="font-medium text-gray-800">${citation.title}</h4>
                  <p class="text-sm text-gray-600 mt-1">${citation.content}</p>
                  <p class="text-xs text-blue-600 mt-2">
                    경제용 ${
                      citation.source_type === "economy_terms"
                        ? "경제 용어"
                        : "최신 콘텐츠"
                    }
                  </p>
                </div>
              </div>
            `;

            // 클릭 시 내부 문서로 이동
            sourceDiv.addEventListener("click", () => {
              openInternalDocument(citation.file_name, citation.source_type);
            });
          } else {
            // 웹 검색 출처
            sourceDiv.innerHTML = `
              <div class="flex items-start gap-3">
                <div class="text-gray-400">${citation.number}</div>
                <div class="flex-1">
                  <h4 class="font-medium text-gray-800">${citation.title}</h4>
                  <p class="text-sm text-gray-600 mt-1">${citation.content}</p>
                  <p class="text-xs text-green-600 mt-2">웹 검색 결과</p>
                </div>
              </div>
            `;
          }

          sourcesContainer.appendChild(sourceDiv);
        });
      }

      // AI 추천 검색어 클릭
      document.querySelectorAll(".search-suggestion").forEach((suggestion) => {
        suggestion.addEventListener("click", () => {
          const query = suggestion.querySelector("p").textContent;

          // 현재 활성화된 탭에 따라 입력 필드 설정
          const isMainTab = !document
            .getElementById("chatbot-section")
            .classList.contains("hidden");
          const inputField = isMainTab
            ? document.getElementById("chat-input")
            : document.getElementById("ai-chat-input");
          inputField.value = query;

          if (isMainTab) {
            performSearch(query);
          } else {
            performAISearch(query);
          }
        });
      });
    </script>
  </body>
</html>
